name: Deluge KB Refresh

on:
  workflow_dispatch:
  schedule:
    - cron: "0 8 * * 1"

jobs:
  refresh-deluge-kb:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Refresh Deluge KB and generate diff report
        id: refresh
        run: |
          set +e
          npm run kb:deluge:refresh
          status=$?
          echo "status=$status" >> "$GITHUB_OUTPUT"
          exit 0

      - name: Upload Deluge KB Diff Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: deluge-kb-diff-report
          path: |
            data/reports/deluge-kb-diff-report.json
            data/reports/deluge-kb-diff-report.md
          if-no-files-found: warn

      - name: Enforce manual curation review for Tier A changes
        if: steps.refresh.outputs.status != '0'
        run: |
          echo "Deluge KB refresh signaled manual review requirement or refresh failure."
          echo "See data/reports/deluge-kb-diff-report.md artifact."
          exit 1
